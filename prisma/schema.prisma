// Life Ops Dashboard - Prisma Schema
// Domain entities for ADHD-optimized task management

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CAPTURE - Raw input from Upload Ideas
// ============================================

enum CaptureStatus {
  UNPROCESSED
  PROCESSED
  PARKED
  DELETED
}

model CaptureItem {
  id          String        @id @default(cuid())
  rawText     String
  capturedAt  DateTime      @default(now())
  status      CaptureStatus @default(UNPROCESSED)
  source      String        @default("manual") // manual, email, api, etc.

  // Relationships
  tasks       Task[]        // A capture item can spawn multiple tasks
  auditEvents AuditEvent[]

  @@index([status])
  @@index([capturedAt])
}

// ============================================
// TASK - Clarified and actionable items
// ============================================

enum TaskStatus {
  DRAFT         // Being clarified, not yet ready
  READY         // Meets DoD criteria, ready to prioritize
  NOW           // Active priority (max 1)
  NEXT          // Up next (max 3)
  LATER         // Backlog
  SCHEDULED     // Has a timeblock
  IN_PROGRESS   // Currently executing
  DONE          // Completed
  ABANDONED     // Explicitly abandoned with reason
}

enum DomainArea {
  WORK
  PERSONAL
  HEALTH
  LEARNING
  ADMIN
  CREATIVE
  SOCIAL
  OTHER
}

model Task {
  id                  String      @id @default(cuid())
  title               String
  domainArea          DomainArea?
  status              TaskStatus  @default(DRAFT)

  // Definition of Done (1-3 bullets)
  dodItems            String[]    @default([])

  // Next Action (one-sitting task)
  nextAction          String?

  // Duration estimate in minutes
  durationMinutes     Int?

  // Optional metadata
  notes               String?
  tags                String[]    @default([])

  // Relationships
  originCaptureItemId String?
  originCaptureItem   CaptureItem? @relation(fields: [originCaptureItemId], references: [id])

  timeBlocks          TimeBlock[]
  shippedOutputs      ShippedOutput[]
  auditEvents         AuditEvent[]

  // Timestamps
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  @@index([status])
  @@index([domainArea])
  @@index([createdAt])
}

// ============================================
// TIMEBLOCK - Scheduled execution slots
// ============================================

model TimeBlock {
  id              String    @id @default(cuid())
  date            DateTime  // Which day
  startTime       DateTime  // Actual start time
  timeboxMinutes  Int       // 25, 45, 60, or 90

  // Ordering within the day
  ordering        Int       @default(0)

  // Relationships
  taskId          String?
  task            Task?     @relation(fields: [taskId], references: [id])

  shippedOutputs  ShippedOutput[]
  auditEvents     AuditEvent[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([date])
  @@index([taskId])
}

// ============================================
// SHIPPED OUTPUT - Evidence of completion
// ============================================

enum OutputType {
  CODE_PR
  DOCUMENT
  DECISION
  COMMUNICATION
  PROTOTYPE
  NOTE
  OTHER
}

model ShippedOutput {
  id            String      @id @default(cuid())
  type          OutputType
  note          String      // Description or link

  // Relationships
  taskId        String
  task          Task        @relation(fields: [taskId], references: [id])

  timeBlockId   String?
  timeBlock     TimeBlock?  @relation(fields: [timeBlockId], references: [id])

  auditEvents   AuditEvent[]

  createdAt     DateTime    @default(now())

  @@index([taskId])
  @@index([createdAt])
}

// ============================================
// AUDIT - Change tracking for all entities
// ============================================

enum EntityType {
  CAPTURE_ITEM
  TASK
  TIME_BLOCK
  SHIPPED_OUTPUT
}

model AuditEvent {
  id          String      @id @default(cuid())
  entityType  EntityType
  entityId    String
  action      String      // e.g., "created", "status_changed", "parked", "abandoned"
  payload     Json?       // Any additional data about the change

  // Relationships (optional, for easier querying)
  captureItemId String?
  captureItem   CaptureItem? @relation(fields: [captureItemId], references: [id])

  taskId        String?
  task          Task?        @relation(fields: [taskId], references: [id])

  timeBlockId   String?
  timeBlock     TimeBlock?   @relation(fields: [timeBlockId], references: [id])

  shippedOutputId String?
  shippedOutput   ShippedOutput? @relation(fields: [shippedOutputId], references: [id])

  timestamp   DateTime    @default(now())

  @@index([entityType, entityId])
  @@index([timestamp])
}
