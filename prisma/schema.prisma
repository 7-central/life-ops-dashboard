// Life Ops Dashboard - Prisma Schema
// Domain entities for operational task management

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CAPTURE - Raw input from Upload Ideas
// ============================================

enum CaptureStatus {
  UNPROCESSED
  PROCESSED
  PARKED
  DELETED
}

model CaptureItem {
  id          String        @id @default(cuid())
  rawText     String
  capturedAt  DateTime      @default(now())
  status      CaptureStatus @default(UNPROCESSED)
  source      String        @default("manual") // manual, email, api, etc.

  // Relationships
  tasks       Task[]        // A capture item can spawn multiple tasks
  auditEvents AuditEvent[]

  @@index([status])
  @@index([capturedAt])
}

// ============================================
// DOMAIN AREA - User-managed categories
// ============================================

model DomainArea {
  id        String   @id @default(cuid())
  name      String   @unique
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)

  tasks     Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([sortOrder])
}

// ============================================
// PROJECT - User-managed projects
// ============================================

model Project {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)

  tasks       Task[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
}

// ============================================
// TASK - Clarified and actionable items
// ============================================

enum TaskStatus {
  DRAFT         // Being clarified, not yet ready
  READY         // Meets DoD criteria, ready to prioritize
  NOW           // Active priority (max 1)
  NEXT          // Up next (max 3)
  LATER         // Backlog
  SCHEDULED     // Has a timeblock
  IN_PROGRESS   // Currently executing
  DONE          // Completed
  ABANDONED     // Explicitly abandoned with reason
}

enum PriorityBucket {
  NOW
  NEXT
  LATER
}

enum EnergyLevel {
  HIGH
  MEDIUM
  LOW
}

model Task {
  id                  String      @id @default(cuid())
  title               String
  status              TaskStatus  @default(DRAFT)

  // Definition of Done (1-3 bullets)
  dodItems            String[]    @default([])

  // Next Action (one-sitting task)
  nextAction          String?

  // Duration estimate in minutes
  durationMinutes     Int?

  // Priority management
  priorityBucket      PriorityBucket?

  // Scheduling
  dueAt               DateTime?

  // Planning metadata
  energyFit           EnergyLevel?
  urgency             Int?        // 1-5 scale
  impact              Int?        // 1-5 scale
  effort              Int?        // 1-5 scale

  // Optional metadata
  notes               String?
  tags                String[]    @default([])
  contexts            String[]    @default([])

  // Relationships
  domainAreaId        String?
  domainArea          DomainArea?  @relation(fields: [domainAreaId], references: [id])

  projectId           String?
  project             Project?     @relation(fields: [projectId], references: [id])

  originCaptureItemId String?
  originCaptureItem   CaptureItem? @relation(fields: [originCaptureItemId], references: [id])

  followOnOfTaskId    String?      // For v1 done + follow-on flow
  followOnOf          Task?        @relation("FollowOnTasks", fields: [followOnOfTaskId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  followOnTasks       Task[]       @relation("FollowOnTasks")

  timeBlocks          TimeBlock[]
  shippedOutputs      ShippedOutput[]
  auditEvents         AuditEvent[]

  // Timestamps
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  @@index([status])
  @@index([domainAreaId])
  @@index([projectId])
  @@index([priorityBucket])
  @@index([dueAt])
  @@index([createdAt])
}

// ============================================
// TIMEBLOCK - Scheduled execution slots
// ============================================

model TimeBlock {
  id              String    @id @default(cuid())
  taskId          String
  task            Task      @relation(fields: [taskId], references: [id])
  scheduledFor    DateTime  // When this block starts
  durationMinutes Int       // 25, 45, 60, or 90 minutes

  // Completion tracking
  completed       Boolean   @default(false)
  actualMinutes   Int?      // How long it actually took
  abandonReason   String?   // If abandoned without completion

  shippedOutputs  ShippedOutput[]
  auditEvents     AuditEvent[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([scheduledFor])
  @@index([taskId])
}

// ============================================
// SHIPPED OUTPUT - Evidence of completion
// ============================================

enum OutputType {
  DRAFT_CREATED
  FILE_SAVED
  SCREENSHOT
  MESSAGE_SENT
  COMMIT_MADE
  ORDER_PLACED
  DECISION_RECORDED
  CODE_PR
  DOCUMENT
  COMMUNICATION
  NOTE
  OTHER
}

model ShippedOutput {
  id            String      @id @default(cuid())
  type          OutputType
  note          String      // Description or link

  // Relationships
  taskId        String
  task          Task        @relation(fields: [taskId], references: [id])

  timeBlockId   String?
  timeBlock     TimeBlock?  @relation(fields: [timeBlockId], references: [id])

  auditEvents   AuditEvent[]

  createdAt     DateTime    @default(now())

  @@index([taskId])
  @@index([createdAt])
}

// ============================================
// AUDIT - Change tracking for all entities
// ============================================

enum EntityType {
  CAPTURE_ITEM
  TASK
  TIME_BLOCK
  SHIPPED_OUTPUT
}

model AuditEvent {
  id          String      @id @default(cuid())
  entityType  EntityType
  entityId    String
  action      String      // e.g., "created", "status_changed", "parked", "abandoned"
  payload     Json?       // Any additional data about the change

  // Relationships (optional, for easier querying)
  captureItemId String?
  captureItem   CaptureItem? @relation(fields: [captureItemId], references: [id])

  taskId        String?
  task          Task?        @relation(fields: [taskId], references: [id])

  timeBlockId   String?
  timeBlock     TimeBlock?   @relation(fields: [timeBlockId], references: [id])

  shippedOutputId String?
  shippedOutput   ShippedOutput? @relation(fields: [shippedOutputId], references: [id])

  timestamp   DateTime    @default(now())

  @@index([entityType, entityId])
  @@index([timestamp])
}
